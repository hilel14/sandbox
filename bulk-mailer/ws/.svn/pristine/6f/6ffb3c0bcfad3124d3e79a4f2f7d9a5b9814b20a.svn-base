package beeriprint.newsletter.camel.dataformats;

import java.io.InputStream;
import java.io.OutputStream;
import javax.mail.internet.MimeMessage;
import org.apache.camel.Exchange;
import org.apache.camel.spi.DataFormat;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 *
 * @author hilel
 */
public class ImapToMessage implements DataFormat {

    final Logger logger = LoggerFactory.getLogger(getClass());

    @Override
    public void marshal(Exchange exchange, Object graph, OutputStream outputStream) throws Exception {
        byte[] bytes = exchange.getContext().getTypeConverter().mandatoryConvertTo(byte[].class, graph);
        outputStream.write(bytes);
    }

    @Override
    public Object unmarshal(Exchange exchange, InputStream inputStream) throws Exception {
        //byte[] bytes = exchange.getContext().getTypeConverter().mandatoryConvertTo(byte[].class, inputStream);
        //MimeMessage mimeMessage = new MimeMessage(null, new ByteArrayInputStream(bytes));
        MimeMessage mimeMessage = exchange.getContext().getTypeConverter().mandatoryConvertTo(MimeMessage.class, inputStream);
        logger.info("Converting message with subject: " + mimeMessage.getSubject());
        return mimeMessage;
    }
}
