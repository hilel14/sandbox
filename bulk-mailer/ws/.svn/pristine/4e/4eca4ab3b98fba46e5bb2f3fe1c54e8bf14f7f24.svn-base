package beeriprint.newsletter.camel;

import beeriprint.newsletter.model.UserActivity;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.HashMap;
import java.util.Map;
import org.apache.camel.Exchange;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 *
 * @author hilel
 */
public class QueryBuilder {

    final Logger logger = LoggerFactory.getLogger(getClass());
    final String insertOpened
            = "INSERT INTO activity (email_id, activity_time, activity_type, resource_id) "
            + "VALUES (:?messageCode, :?requestTime, 'opened', 0)";
    final String insertClicked
            = "INSERT INTO activity (email_id, activity_time, activity_type, resource_id) "
            + "VALUES (:?messageCode, :?requestTime, 'clicked', :?resourceId)";
    final String selectEmailByMessage
            = "SELECT user_part, domain_part FROM email WHERE id = ?";
    final String selectUnsubscribed
            = "SELECT email FROM unsubscribe WHERE email = ?";
    final String insertUnsubscribe
            = "INSERT INTO unsubscribe (email, request_time) VALUES (:?email, :?requestTime)";
    Map updateParameters;

    public void insertOpened(Exchange exchange, UserActivity statusUpdate) throws Exception {
        updateParameters = new HashMap();
        updateParameters.put("messageCode", statusUpdate.getMessageCode());
        updateParameters.put("requestTime", statusUpdate.getRequestTime().getTime());
        exchange.getOut().setBody(insertOpened);
        exchange.getOut().setHeader("CamelJdbcParameters", updateParameters);
    }

    public void insertClicked(Exchange exchange, UserActivity statusUpdate) throws Exception {
        updateParameters = new HashMap();
        updateParameters.put("messageCode", statusUpdate.getMessageCode());
        updateParameters.put("requestTime", statusUpdate.getRequestTime().getTime());
        updateParameters.put("resourceId", statusUpdate.getResourceId());
        exchange.getOut().setBody(insertClicked);
        exchange.getOut().setHeader("CamelJdbcParameters", updateParameters);
    }

    public void selectEmailByMessage(Exchange exchange, UserActivity statusUpdate) throws Exception {
        updateParameters = new HashMap();
        updateParameters.put("messageCode", statusUpdate.getMessageCode());
        exchange.getOut().setBody(selectEmailByMessage);
        exchange.getOut().setHeader("CamelJdbcParameters", updateParameters);
    }

    public void selectUnsubscribed(Exchange exchange, ArrayList<HashMap<String, Object>> results) {
        HashMap<String, Object> record = results.get(0);
        String userPart = record.get("user_part").toString();
        String domainPart = record.get("domain_part").toString();
        String email = userPart.toLowerCase() + "@" + domainPart.toLowerCase();
        updateParameters = new HashMap();
        updateParameters.put("email", email);
        exchange.getOut().setBody(selectUnsubscribed);
        exchange.getOut().setHeader("CamelJdbcParameters", updateParameters);
        exchange.getOut().setHeader("NewsletterUnsubscriber", email);
    }

    public void insertUnsubscribe(Exchange exchange, ArrayList<HashMap<String, Object>> results) throws Exception {
        updateParameters = new HashMap();
        updateParameters.put("email", exchange.getIn().getHeader("NewsletterUnsubscriber"));
        updateParameters.put("requestTime", Calendar.getInstance().getTime());
        exchange.getOut().setBody(insertUnsubscribe);
        exchange.getOut().setHeader("CamelJdbcParameters", updateParameters);
    }
}
