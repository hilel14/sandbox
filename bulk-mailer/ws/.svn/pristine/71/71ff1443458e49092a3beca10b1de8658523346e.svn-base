package beeriprint.newsletter.camel;

import beeriprint.newsletter.model.StatusUpdate;
import com.sun.mail.dsn.DeliveryStatus;
import com.sun.mail.dsn.MultipartReport;
import java.io.IOException;
import java.util.Enumeration;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import javax.mail.Header;
import javax.mail.Message;
import javax.mail.MessagingException;
import javax.mail.internet.MimeMessage;
import org.apache.camel.Exchange;
import org.apache.camel.component.mail.MailMessage;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 *
 * @author hilel-deb
 */
public class DsnParser {

    final Logger logger = LoggerFactory.getLogger(getClass());
    final Pattern esmtpPattern = Pattern.compile("[45]\\.[0-9]{1,3}\\.[0-9]{1,3}");

    public void process(Exchange exchange) throws Exception {
        StatusUpdate statusUpdate = new StatusUpdate();
        MailMessage mailMessage = exchange.getIn(MailMessage.class);
        //mailMessage.setHeader("valid.ebill.dsn", false);
        Message message = mailMessage.getOriginalMessage();
        logger.debug("Analyzing message with subject: " + message.getSubject());
        // Extract MultipartReport
        // When deploying to Apache Karaf, make sure to include META-INF/mail.cap from dsn.jar
        MultipartReport multipartReport;
        try {
            multipartReport = (MultipartReport) message.getContent();
        } catch (IOException | MessagingException | ClassCastException ex) {
            logger.debug("Not a valid multipart-report");
            return;
        }
        // Extract action, status diagnostic codes
        DeliveryStatus deliveryStatus = (DeliveryStatus) multipartReport.getReport();
        parseDeliveryStatus(deliveryStatus, statusUpdate);
        // Extract original message id
        MimeMessage returnedMessage = multipartReport.getReturnedMessage();
        if (returnedMessage == null) {
            logger.debug("Returned message not found");
            return;
        }
        String recordId = returnedMessage.getHeader("X-recordId", null);
        if (recordId == null) {
            logger.debug("Header not found: X-recordId");
            return;
        }
        statusUpdate.setMessageCode(recordId);
        // finish
        //statusUpdate.setDsn(true);
        exchange.getIn().setHeader("valid.dsn", true);
        exchange.getIn().setBody(statusUpdate);
    }

    private void parseDeliveryStatus(DeliveryStatus deliveryStatus, StatusUpdate statusUpdate) throws Exception {
        Enumeration headers = deliveryStatus.getRecipientDSN(0).getAllHeaders();
        while (headers.hasMoreElements()) {
            Header h = (Header) headers.nextElement();
            // action code
            if (h.getName().equalsIgnoreCase("Action")) {
                if (h.getValue() != null) {
                    String actionCode = h.getValue().trim();
                    if (actionCode.length() > 20) {
                        actionCode = actionCode.substring(0, 20);
                        String[] words = actionCode.split(" ");
                        if (words.length > 1) {
                            actionCode = words[0];
                        }
                    }
                    statusUpdate.setActionCode(actionCode);
                }
            }
            // status code
            if (h.getName().equalsIgnoreCase("Status")) {
                Matcher matcher = esmtpPattern.matcher(h.getValue());
                if (matcher.find()) {
                    statusUpdate.setStatusCode(matcher.group());
                }
            }
            // diagnostic code
            if (h.getName().equalsIgnoreCase("Diagnostic-code")) {
                String diagnosticCode = h.getValue();
                diagnosticCode = diagnosticCode.replaceAll("\\n", "").replaceAll("\\r", "");
                diagnosticCode = diagnosticCode.trim();
                if (diagnosticCode.length() > 512) {
                    diagnosticCode = diagnosticCode.substring(0, 512);
                }
                statusUpdate.setDiagnosticCode(diagnosticCode);
            }
        }
    }
}
