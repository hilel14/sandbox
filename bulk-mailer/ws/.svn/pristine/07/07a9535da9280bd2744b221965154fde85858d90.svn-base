package beeriprint.newsletter.camel.processors;

import beeriprint.newsletter.model.UserActivity;
import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.util.HashMap;
import java.util.Map;
import org.apache.camel.Exchange;
import org.apache.camel.Processor;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 *
 * @author hilel
 */
public class PrepareInsertActivity implements Processor {

    final Logger logger = LoggerFactory.getLogger(getClass());
    final DateFormat dateFormat = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
    final String insertOpened
            = "INSERT INTO activity (email_id, activity_time, activity_type, resource_id) "
            + "VALUES (:?messageCode, :?requestTime, 'opened', 0)";
    final String insertClicked
            = "INSERT INTO activity (email_id, activity_time, activity_type, resource_id) "
            + "VALUES (:?messageCode, :?requestTime, 'clicked', :?resourceId)";

    @Override
    public void process(Exchange exchange) throws Exception {
        UserActivity activity = exchange.getIn().getBody(UserActivity.class);
        Map jdbcParameters = new HashMap();
        jdbcParameters.put("messageCode", activity.getMessageCode());
        jdbcParameters.put("resourceId", activity.getResourceId());
        String requestTime = dateFormat.format(activity.getRequestTime().getTime());
        jdbcParameters.put("requestTime", requestTime);
        switch (activity.getActivityType()) {
            case "open":
                jdbcParameters.put("activityType", "opened");
                exchange.getOut().setBody(insertOpened);
                break;
            case "click":
                jdbcParameters.put("activityType", "clicked");
                exchange.getOut().setBody(insertClicked);
                break;
            default:
                throw new IllegalArgumentException("Invalid activity type: " + activity.getActivityType());
        }
        exchange.getOut().setHeader("CamelJdbcParameters", jdbcParameters);
    }
}
