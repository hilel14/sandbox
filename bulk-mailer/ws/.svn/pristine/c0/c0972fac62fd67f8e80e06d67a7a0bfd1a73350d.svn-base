package beeriprint.newsletter.camel.processors;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.Map;
import org.apache.camel.Exchange;
import org.apache.camel.Processor;

/**
 *
 * @author hilel
 */
public class PrepareSelectUnsubscribe implements Processor {

    final String query = "SELECT email FROM unsubscribe WHERE email = ?";

    @Override
    public void process(Exchange exchange) throws Exception {
        ArrayList<HashMap<String, Object>> results = exchange.getIn().getBody(ArrayList.class);
        HashMap<String, Object> record = results.get(0);
        String userPart = record.get("user_part").toString();
        String domainPart = record.get("domain_part").toString();
        String email = userPart.toLowerCase() + "@" + domainPart.toLowerCase();
        Map jdbcParameters = new HashMap();
        jdbcParameters.put("email", email);
        exchange.getOut().setBody(query);
        exchange.getOut().setHeader("CamelJdbcParameters", jdbcParameters);
        exchange.getOut().setHeader("NewsletterUnsubscriber", email);
    }
}
