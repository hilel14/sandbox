#!/bin/sh

# ActiveMQ installation and configuration script

# Prerequisites: 
# **********************************************
# ActiveMQ installation file
# **********************************************

# Global variables:
# **********************************************
ACTIVEMQ_VERSION=5.11.1
# **********************************************

# exit on first error
set -e

#  make sure activemq installation file exits
activemqArchFile=`dirname $0`/apache-activemq-$ACTIVEMQ_VERSION-bin.tar.gz
if ! [ -f $activemqArchFile ]; then
#	wget http://archive.apache.org/dist/activemq/$ACTIVEMQ_VERSION/apache-activemq-$ACTIVEMQ_VERSION-bin.tar.gz
	echo "File not found: $activemqArchFile"
	exit 1
fi

# extract binary distribution archive and move to /opt/apache
tar xvf $activemqArchFile
mkdir --parents /opt/apache/activemq
mv apache-activemq-$ACTIVEMQ_VERSION /opt/apache/activemq/$ACTIVEMQ_VERSION

# configure systemd service
#
useradd --system --home-dir=/opt/apache/activemq/$ACTIVEMQ_VERSION activemq
chown -R activemq /opt/apache/activemq/$ACTIVEMQ_VERSION/
#
cat <<EOF > /etc/systemd/system/activemq.service
[Unit]
Description=Apache ActiveMQ messaging and Integration Patterns server
After=syslog.target network.target
[Service]
Type=forking
PIDFile=/opt/apache/activemq/$ACTIVEMQ_VERSION/data/activemq.pid
ExecStart=/opt/apache/activemq/$ACTIVEMQ_VERSION/bin/activemq start
User=activemq
Group=activemq
[Install]
WantedBy=multi-user.target
EOF
#
systemctl enable activemq.service

# open broker and admin ports in firewall
firewall-cmd --permanent --add-port 61616/tcp
firewall-cmd --permanent --add-port 8161/tcp

