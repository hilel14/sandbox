package beeriprint.newsletter.camel;

import com.sun.mail.dsn.DeliveryStatus;
import com.sun.mail.dsn.MultipartReport;
import java.io.IOException;
import java.util.Enumeration;
import java.util.HashMap;
import java.util.Map;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import javax.mail.Header;
import javax.mail.Message;
import javax.mail.MessagingException;
import javax.mail.internet.MimeMessage;
import org.apache.camel.Exchange;
import org.apache.camel.component.mail.MailMessage;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 *
 * @author hilel-deb
 */
public class DsnParser {

    final Logger logger = LoggerFactory.getLogger(getClass());
    final Pattern esmtpPattern = Pattern.compile("[45]\\.[0-9]{1,3}\\.[0-9]{1,3}");
    final String updateDsnQuery
            = "UPDATE email SET action_code  = :?actionCode, status_code = :?statusCode, diagnostic_code = :?diagnosticCode "
            + "WHERE id = :?messageCode";

    public void process(Exchange exchange) throws Exception {

        exchange.getIn().setHeader("newsletter.validDsn", false);

        MailMessage mailMessage = exchange.getIn(MailMessage.class);
        //mailMessage.setHeader("valid.ebill.dsn", false);
        Message message = mailMessage.getOriginalMessage();
        logger.debug("Analyzing message with subject: " + message.getSubject());
        // Extract MultipartReport
        // When deploying to Apache Karaf, make sure to include META-INF/mail.cap from dsn.jar
        MultipartReport multipartReport;
        try {
            multipartReport = (MultipartReport) message.getContent();
        } catch (IOException | MessagingException | ClassCastException ex) {
            logger.debug("Not a valid multipart-report");
            return;
        }
        // Extract action, status diagnostic codes
        DeliveryStatus deliveryStatus = (DeliveryStatus) multipartReport.getReport();
        Map jdbcParameters = parseDeliveryStatus(deliveryStatus);
        // Extract original message id
        MimeMessage returnedMessage = multipartReport.getReturnedMessage();
        if (returnedMessage == null) {
            logger.debug("Returned message not found");
            return;
        }
        String recordId = returnedMessage.getHeader("X-recordId", null);
        if (recordId == null) {
            logger.debug("Header not found: X-recordId");
            return;
        }
        jdbcParameters.put("messageCode", recordId);
        // finish
        exchange.getOut().setHeader("newsletter.validDsn", true);
        exchange.getOut().setHeader("CamelJdbcParameters", jdbcParameters);
        exchange.getOut().setBody(updateDsnQuery);
    }

    private Map parseDeliveryStatus(DeliveryStatus deliveryStatus) throws Exception {
        // initialize results map
        Map jdbcParameters = new HashMap();
        jdbcParameters.put("actionCode", null);
        jdbcParameters.put("statusCode", null);
        jdbcParameters.put("diagnosticCode", null);
        // get all headers
        Enumeration headers = deliveryStatus.getRecipientDSN(0).getAllHeaders();
        while (headers.hasMoreElements()) {
            Header h = (Header) headers.nextElement();
            // action code
            if (h.getName().equalsIgnoreCase("Action")) {
                if (h.getValue() != null) {
                    String actionCode = h.getValue().trim();
                    if (actionCode.length() > 20) {
                        actionCode = actionCode.substring(0, 20);
                        String[] words = actionCode.split(" ");
                        if (words.length > 1) {
                            actionCode = words[0];
                        }
                    }
                    jdbcParameters.put("actionCode", actionCode);
                }
            }
            // status code
            if (h.getName().equalsIgnoreCase("Status")) {
                Matcher matcher = esmtpPattern.matcher(h.getValue());
                if (matcher.find()) {
                    jdbcParameters.put("statusCode", matcher.group());
                }
            }
            // diagnostic code
            if (h.getName().equalsIgnoreCase("Diagnostic-code")) {
                String diagnosticCode = h.getValue();
                diagnosticCode = diagnosticCode.replaceAll("\\n", "").replaceAll("\\r", "");
                diagnosticCode = diagnosticCode.trim();
                if (diagnosticCode.length() > 512) {
                    diagnosticCode = diagnosticCode.substring(0, 512);
                }
                jdbcParameters.put("diagnosticCode", diagnosticCode);
            }
        }
        return jdbcParameters;
    }
}
